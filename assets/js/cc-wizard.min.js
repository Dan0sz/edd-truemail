(d=>{let e={currentSlide:0,doToken:"",appUrl:"",accessToken:"",init:function(){this.bindEvents(),this.showSlide(0)},bindEvents:function(){d(document).on("click",".cc-wizard-next",this.nextSlide.bind(this)),d(document).on("input","#cc-do-token",this.validateToken.bind(this)),d(document).on("click",".cc-wizard-create-app",this.createApp.bind(this)),d(document).on("click",".cc-wizard-remove-token",this.removeToken.bind(this)),d(document).on("click",".cc-wizard-complete",this.completeWizard.bind(this))},showSlide:function(e){d(".cc-wizard-slide").hide(),d('.cc-wizard-slide[data-slide="'+e+'"]').fadeIn(300),this.currentSlide=e},nextSlide:function(e){e.preventDefault(),2===this.currentSlide&&(this.doToken=d("#cc-do-token").val().trim()),this.showSlide(this.currentSlide+1)},validateToken:function(){var e=d("#cc-do-token").val().trim(),t=d('.cc-wizard-slide[data-slide="2"] .cc-wizard-next');20<e.length?t.prop("disabled",!1):t.prop("disabled",!0)},createApp:function(e){e.preventDefault();var e=d(e.currentTarget),t=d('.cc-wizard-slide[data-slide="3"]'),r=t.find(".cc-wizard-content-main");let i=t.find(".cc-wizard-progress");t.find(".cc-wizard-error");e.hide(),r.fadeOut(200,function(){i.fadeIn(300)}),this.provisionServer()},provisionServer:function(){let c=this;let o=["project","server","install","secure","done"];!function t(i){var e,r,n,a;e=i,r=d(".cc-wizard-progress-steps li"),n=d(".cc-wizard-progress-fill"),a=(e+1)/o.length*100,r.removeClass("active complete error"),r.eq(e).addClass("active"),r.slice(0,e).addClass("complete"),n.css("width",a+"%"),d.ajax({url:ccWizard.ajaxUrl,type:"POST",data:{action:"cc_wizard_provision",nonce:ccWizard.nonce,step:o[i],token:c.doToken},success:function(e){e.success?(e.data.app_url&&(c.appUrl=e.data.app_url),e.data.access_token&&(c.accessToken=e.data.access_token),i<o.length-1?setTimeout(function(){t(i+1)},500):setTimeout(function(){c.saveCredentials()},1e3)):c.handleProvisioningError(e.data,i)},error:function(e,t,r){c.handleProvisioningError({message:"Network error: "+r,code:"network_error"},i)}})}(0)},handleProvisioningError:function(e,t){var r=d('.cc-wizard-slide[data-slide="3"]'),i=r.find(".cc-wizard-progress");let n=r.find(".cc-wizard-error"),a=n.find(".cc-wizard-error-message"),c=n.find(".cc-wizard-error-actions");d(".cc-wizard-progress-steps li").eq(t).addClass("error"),i.fadeOut(200,function(){a.text(e.message||"An error occurred during setup."),"payment_method_required"===e.code?c.html('<a href="https://cloud.digitalocean.com/account/billing" target="_blank" class="button">Add payment method</a><button type="button" class="button button-primary cc-wizard-retry">Retry setup</button>'):c.html('<button type="button" class="button button-primary cc-wizard-retry">Retry setup</button>'),n.fadeIn(300)}),d(document).on("click",".cc-wizard-retry",this.retryProvisioning.bind(this))},retryProvisioning:function(e){e.preventDefault();var e=d('.cc-wizard-slide[data-slide="3"]'),t=e.find(".cc-wizard-error");let r=e.find(".cc-wizard-progress");d(".cc-wizard-progress-steps li").removeClass("active complete error"),d(".cc-wizard-progress-fill").css("width","0%"),t.fadeOut(200,function(){r.fadeIn(300)}),this.provisionServer()},saveCredentials:function(){let t=this;d.ajax({url:ccWizard.ajaxUrl,type:"POST",data:{action:"cc_wizard_save_credentials",nonce:ccWizard.nonce,app_url:this.appUrl,access_token:this.accessToken,do_token:this.doToken},success:function(e){e.success?t.showSlide(4):alert("Failed to save credentials. Please try again.")},error:function(){alert("Failed to save credentials. Please try again.")}})},removeToken:function(e){e.preventDefault();let t=d(e.currentTarget);t.prop("disabled",!0).text("Removing..."),d.ajax({url:ccWizard.ajaxUrl,type:"POST",data:{action:"cc_wizard_remove_token",nonce:ccWizard.nonce},success:function(e){e.success?(t.text("Token removed").addClass("button-disabled"),d(".cc-wizard-token-cleanup").fadeOut(300)):(t.prop("disabled",!1).text("Remove API token"),alert("Failed to remove token. Please try again."))},error:function(){t.prop("disabled",!1).text("Remove API token"),alert("Failed to remove token. Please try again.")}})},completeWizard:function(e){e.preventDefault();let t=d(e.currentTarget);t.prop("disabled",!0).text("Completing..."),d.ajax({url:ccWizard.ajaxUrl,type:"POST",data:{action:"cc_wizard_complete",nonce:ccWizard.nonce},success:function(e){e.success?window.location.reload():(t.prop("disabled",!1).text("Continue to settings"),alert("Failed to complete setup. Please try again."))},error:function(){t.prop("disabled",!1).text("Continue to settings"),alert("Failed to complete setup. Please try again.")}})}};d(document).ready(function(){d(".cc-wizard-wrap").length&&e.init()})})(jQuery);