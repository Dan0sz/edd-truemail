(o=>{let e={currentSlide:0,doToken:"",appUrl:"",accessToken:"",init:function(){this.bindEvents(),this.doToken=o("#cc-do-token").val().trim();var e=window.location.hash;let t=0;e&&e.startsWith("#slide-")&&(e=parseInt(e.replace("#slide-","")),!isNaN(e))&&0<=e&&e<=4&&(t=e),this.showSlide(t),o("#cc-do-token").val()&&this.validateToken()},bindEvents:function(){o(document).on("click",".cc-wizard-nav-item",this.handleNavClick.bind(this)),o(document).on("click",".cc-wizard-next",this.nextSlide.bind(this)),o(document).on("input","#cc-do-token",this.validateToken.bind(this)),o(document).on("click",".cc-wizard-create-app",this.createApp.bind(this)),o(document).on("click",".cc-wizard-remove-token",this.removeToken.bind(this)),o(document).on("click",".cc-wizard-complete",this.completeWizard.bind(this)),o(window).on("hashchange",this.handleHashChange.bind(this))},handleNavClick:function(e){e.preventDefault();var e=o(e.currentTarget),t=parseInt(e.data("slide"));e.hasClass("disabled")||(e.hasClass("completed")||e.hasClass("nav-tab-active"))&&this.showSlide(t)},showSlide:function(e){o(".cc-wizard-slide").hide(),o('.cc-wizard-slide[data-slide="'+e+'"]').fadeIn(300),this.currentSlide=e,window.location.hash="slide-"+e,this.updateNavigationStates(e)},handleHashChange:function(){var e=window.location.hash;e&&e.startsWith("#slide-")&&(e=parseInt(e.replace("#slide-","")),!isNaN(e))&&0<=e&&e<=4&&e!==this.currentSlide&&(o(".cc-wizard-slide").hide(),o('.cc-wizard-slide[data-slide="'+e+'"]').fadeIn(300),this.currentSlide=e,this.updateNavigationStates(e))},updateNavigationStates:function(a){o(".cc-wizard-nav-item").each(function(){var e=o(this),t=parseInt(e.data("slide"));e.removeClass("nav-tab-active completed disabled"),t===a?e.addClass("nav-tab-active"):t<a?e.addClass("completed"):e.addClass("disabled")})},nextSlide:function(e){e.preventDefault(),2===this.currentSlide&&this.saveDOToken(),this.showSlide(this.currentSlide+1)},validateToken:function(){var e=o("#cc-do-token").val().trim(),t=o('.cc-wizard-slide[data-slide="2"] .cc-wizard-next');20<e.length?t.prop("disabled",!1):t.prop("disabled",!0)},saveDOToken:function(){var e=o("#cc-do-token").val().trim();(this.doToken=e).length<=20||o.ajax({url:ccWizard.ajaxUrl,type:"POST",data:{action:"cc_wizard_save_do_token",nonce:ccWizard.nonce,token:e},success:function(e){e.success&&console.log("DO token saved.")}})},createApp:function(e){e.preventDefault();var e=o(e.currentTarget),t=o('.cc-wizard-slide[data-slide="3"]'),a=t.find(".cc-wizard-content-main");let i=t.find(".cc-wizard-progress");t.find(".cc-wizard-error");e.hide(),a.fadeOut(200,function(){i.fadeIn(300)}),this.provisionServer()},provisionServer:function(){let r=this;let s=["project","server","install","secure","done"];!function t(i){var e,a,n,c;e=i,a=o(".cc-wizard-progress-steps li"),n=o(".cc-wizard-progress-fill"),c=(e+1)/s.length*100,a.removeClass("active complete error"),a.eq(e).addClass("active"),a.slice(0,e).addClass("complete"),n.css("width",c+"%"),o.ajax({url:ccWizard.ajaxUrl,type:"POST",data:{action:"cc_wizard_provision",nonce:ccWizard.nonce,step:s[i],token:r.doToken},success:function(e){e.success?(e.data.app_url&&(r.appUrl=e.data.app_url),e.data.access_token&&(r.accessToken=e.data.access_token),i<s.length-1?setTimeout(function(){t(i+1)},500):setTimeout(function(){r.saveCredentials()},1e3)):r.handleProvisioningError(e.data,i)},error:function(e,t,a){r.handleProvisioningError({message:"Network error: "+a,code:"network_error"},i)}})}(0)},handleProvisioningError:function(e,t){var a=o('.cc-wizard-slide[data-slide="3"]'),i=a.find(".cc-wizard-progress");let n=a.find(".cc-wizard-error"),c=n.find(".cc-wizard-error-message"),r=n.find(".cc-wizard-error-actions");o(".cc-wizard-progress-steps li").eq(t).addClass("error"),i.fadeOut(200,function(){c.text(e.message||"An error occurred during setup."),"payment_method_required"===e.code?r.html('<a href="https://cloud.digitalocean.com/account/billing" target="_blank" class="button">Add payment method</a><button type="button" class="button button-primary cc-wizard-retry">Retry setup</button>'):r.html('<button type="button" class="button button-primary cc-wizard-retry">Retry setup</button>'),n.fadeIn(300)}),o(document).on("click",".cc-wizard-retry",this.retryProvisioning.bind(this))},retryProvisioning:function(e){e.preventDefault();var e=o('.cc-wizard-slide[data-slide="3"]'),t=e.find(".cc-wizard-error");let a=e.find(".cc-wizard-progress");o(".cc-wizard-progress-steps li").removeClass("active complete error"),o(".cc-wizard-progress-fill").css("width","0%"),t.fadeOut(200,function(){a.fadeIn(300)}),this.provisionServer()},saveCredentials:function(){let t=this;o.ajax({url:ccWizard.ajaxUrl,type:"POST",data:{action:"cc_wizard_save_credentials",nonce:ccWizard.nonce,app_url:this.appUrl,access_token:this.accessToken,do_token:this.doToken},success:function(e){e.success?t.showSlide(4):alert("Failed to save credentials. Please try again.")},error:function(){alert("Failed to save credentials. Please try again.")}})},removeToken:function(e){e.preventDefault();let t=o(e.currentTarget);t.prop("disabled",!0).text("Removing..."),o.ajax({url:ccWizard.ajaxUrl,type:"POST",data:{action:"cc_wizard_remove_token",nonce:ccWizard.nonce},success:function(e){e.success?(t.text("Token removed").addClass("button-disabled"),o(".cc-wizard-token-cleanup").fadeOut(300)):(t.prop("disabled",!1).text("Remove API token"),alert("Failed to remove token. Please try again."))},error:function(){t.prop("disabled",!1).text("Remove API token"),alert("Failed to remove token. Please try again.")}})},completeWizard:function(e){e.preventDefault();let t=o(e.currentTarget);t.prop("disabled",!0).text("Completing..."),o.ajax({url:ccWizard.ajaxUrl,type:"POST",data:{action:"cc_wizard_complete",nonce:ccWizard.nonce},success:function(e){e.success?window.location.reload():(t.prop("disabled",!1).text("Continue to settings"),alert("Failed to complete setup. Please try again."))},error:function(){t.prop("disabled",!1).text("Continue to settings"),alert("Failed to complete setup. Please try again.")}})}};o(document).ready(function(){o(".cc-admin").length&&e.init()})})(jQuery);